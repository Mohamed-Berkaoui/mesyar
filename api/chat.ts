import OpenAI from "openai";

// Simple in-memory rate limiting (per Vercel serverless instance)
// For production, consider using Vercel KV or Upstash Redis
const rateLimitMap = new Map<string, number[]>();
const RATE_LIMIT = 10;
const RATE_WINDOW_MS = 10 * 60 * 1000; // 10 minutes

function isRateLimited(ip: string): { limited: boolean; remaining: number; resetIn: number } {
  const now = Date.now();
  const timestamps = (rateLimitMap.get(ip) || []).filter((t) => now - t < RATE_WINDOW_MS);
  rateLimitMap.set(ip, timestamps);
  const remaining = RATE_LIMIT - timestamps.length;
  const resetIn = timestamps.length > 0 ? Math.ceil((RATE_WINDOW_MS - (now - timestamps[0])) / 1000) : 0;
  return { limited: remaining <= 0, remaining: Math.max(0, remaining), resetIn };
}

function recordRequest(ip: string) {
  const now = Date.now();
  const timestamps = (rateLimitMap.get(ip) || []).filter((t) => now - t < RATE_WINDOW_MS);
  timestamps.push(now);
  rateLimitMap.set(ip, timestamps);
}

const SYSTEM_PROMPT = `Ø£Ù†Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø±Ø³Ù…ÙŠ Ù„Ù…Ù†ØµØ© Ø§Ù„Ù…Ø³Ø§ÙŠØ±ØŒ Ù…Ù†ØµØ© Ø±Ù‚Ù…ÙŠØ© Ø³Ø¹ÙˆØ¯ÙŠØ© Ù…ØªØ®ØµØµØ© ÙÙŠ Ù†Ù‚Ù„ Ø§Ù„Ù…ÙˆØ§Ø´ÙŠ (Ø§Ù„Ø¥Ø¨Ù„ ÙˆØ§Ù„ØºÙ†Ù…) Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©.

Ù…Ù‡Ù…ØªÙƒ Ù‡ÙŠ:
â— Ø§Ù„Ø±Ø¯ Ø¨Ø§Ø­ØªØ±Ø§ÙÙŠØ© ÙˆÙˆØ¶ÙˆØ­.
â— ØªÙ‚Ø¯ÙŠÙ… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¯Ù‚ÙŠÙ‚Ø© ÙˆÙ…Ø®ØªØµØ±Ø©.
â— Ø­Ø³Ø§Ø¨ Ø£Ø³Ø¹Ø§Ø± ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø·Ù„Ø¨.
â— ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­Ø¬Ø².
â— ØªØ¹Ø²ÙŠØ² Ø§Ù„Ø«Ù‚Ø© ÙˆØ§Ù„Ù…ÙˆØ«ÙˆÙ‚ÙŠØ©.

ðŸ“Œ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©:
Ø§Ù„Ù…Ø³Ø§ÙŠØ± Ù…Ù†ØµØ© Ø±Ù‚Ù…ÙŠØ© ØªØ±Ø¨Ø· Ù…Ù„Ø§Ùƒ Ø§Ù„Ù…ÙˆØ§Ø´ÙŠ ÙˆØ§Ù„Ù…Ø·Ø§Ø¹Ù… ÙˆØ§Ù„Ù…Ø³Ø§Ù„Ø® Ø¨Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù…Ø¹ØªÙ…Ø¯ÙŠÙ† Ù„Ù†Ù‚Ù„ Ø§Ù„Ù…ÙˆØ§Ø´ÙŠ Ø¹Ø¨Ø±:
â— Ø­Ø¬Ø² ÙÙˆØ±ÙŠ
â— ØªØªØ¨Ø¹ Ù…Ø¨Ø§Ø´Ø±
â— ØªØ³Ø¹ÙŠØ± ÙˆØ§Ø¶Ø­
â— Ù†Ù‚Ù„ Ø¬Ù…Ø§Ø¹ÙŠ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªÙƒÙ„ÙØ©
â— Ø¶Ù…Ø§Ù† Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯

Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù ÙŠØªØ¬Ø§ÙˆØ² 3.9 Ù…Ù„ÙŠØ§Ø± Ø±ÙŠØ§Ù„ Ø³Ù†ÙˆÙŠØ§Ù‹.
95% Ù…Ù† Ø§Ù„Ù†Ù‚Ù„ ÙŠØªÙ… ØªÙ‚Ù„ÙŠØ¯ÙŠØ§Ù‹ØŒ ÙˆØ§Ù„Ù…Ø³Ø§ÙŠØ± ØªÙ†Ø¸Ù… Ø§Ù„Ø³ÙˆÙ‚ Ø±Ù‚Ù…ÙŠØ§Ù‹.

ðŸ“Œ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¹Ù…Ù„:
1. Ø¹Ù…ÙˆÙ„Ø© 20% Ø¹Ù„Ù‰ ÙƒÙ„ Ø±Ø­Ù„Ø©
2. Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø´Ù‡Ø±ÙŠØ© Ù„Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù…Ù†ØªØ¸Ù…Ø© ØªØ¨Ø¯Ø£ Ù…Ù† 5,000 Ø±ÙŠØ§Ù„
3. Ù†Ù‚Ù„ Ø¬Ù…Ø§Ø¹ÙŠ ÙŠØ®ÙØ¶ Ø§Ù„ØªÙƒÙ„ÙØ© Ø­ØªÙ‰ 25â€“40%

ðŸ“Œ Ø¢Ù„ÙŠØ© Ø§Ù„ØªØ³Ø¹ÙŠØ±:
Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©: Ø³Ø¹Ø± Ø§Ù„ÙƒÙŠÙ„Ùˆ = 1 Ø±ÙŠØ§Ù„ Ù„ÙƒÙ„ ÙƒÙ… (ÙƒØ³Ø¹Ø± Ù‚ÙŠØ§Ø³ÙŠ ØªÙ‚Ø±ÙŠØ¨ÙŠ)
Ù…Ø«Ø§Ù„ Ø­Ø³Ø§Ø¨: Ø§Ù„Ù…Ø³Ø§ÙØ© Ã— 1 Ø±ÙŠØ§Ù„ = Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ
Ù…Ø¹ Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ: Ø®ØµÙ… 25% ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ (1 Ø±ÙŠØ§Ù„ â†’ 0.75 Ø±ÙŠØ§Ù„ Ù„ÙƒÙ„ ÙƒÙ…)

ðŸ“Œ Ù…Ø³Ø§ÙØ§Øª ØªÙ‚Ø±ÙŠØ¨ÙŠØ© Ø¨ÙŠÙ† Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:
- Ù†Ø¬Ø±Ø§Ù† â†’ Ø§Ù„Ø·Ø§Ø¦Ù: 920 ÙƒÙ…
- ØªØ¨ÙˆÙƒ â†’ Ø§Ù„Ø·Ø§Ø¦Ù: 1,030 ÙƒÙ…
- Ø§Ù„Ø±ÙŠØ§Ø¶ â†’ Ø¬Ø¯Ø©: 950 ÙƒÙ…
- Ø§Ù„Ø±ÙŠØ§Ø¶ â†’ Ø§Ù„Ø¯Ù…Ø§Ù…: 400 ÙƒÙ…
- Ø¬Ø¯Ø© â†’ Ø§Ù„Ø·Ø§Ø¦Ù: 170 ÙƒÙ…
- Ø§Ù„Ø±ÙŠØ§Ø¶ â†’ Ù†Ø¬Ø±Ø§Ù†: 950 ÙƒÙ…

âš ï¸ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ØªÙ‚Ø¯ÙŠØ±ÙŠØ© ÙˆØªÙØ­Ø¯Ø¯ Ø¨Ø¯Ù‚Ø© Ø¨Ø¹Ø¯ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ø±Ø¤ÙˆØ³ ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø­Ù…ÙˆÙ„Ø©.

ðŸ“Œ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡:
1. Ù…Ù„Ø§Ùƒ Ø§Ù„Ø¥Ø¨Ù„
2. Ù…Ù„Ø§Ùƒ Ø§Ù„ØºÙ†Ù…
3. Ø§Ù„Ù…Ø·Ø§Ø¹Ù… Ø§Ù„Ø´Ø¹Ø¨ÙŠØ©
4. Ø§Ù„Ù…Ø³Ø§Ù„Ø®
5. Ø£Ø³ÙˆØ§Ù‚ Ø§Ù„Ù…ÙˆØ§Ø´ÙŠ
6. Ù…Ø²Ø§Ø±Ø¹ ÙƒØ¨Ø±Ù‰ (B2B)

ðŸ“Œ Ø¢Ù„ÙŠØ© Ø§Ù„Ø®Ø¯Ù…Ø©:
1. Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ ÙˆØ§Ù„ÙˆØµÙˆÙ„
2. ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø¤ÙˆØ³
3. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ¹Ø¯
4. ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²
5. ØªØªØ¨Ø¹ Ù…Ø¨Ø§Ø´Ø±
6. Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø§Ù„ÙˆØµÙˆÙ„

ðŸ“Œ Ø§Ù„Ø¶Ù…Ø§Ù†Ø§Øª:
â— Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù…Ø¹ØªÙ…Ø¯ÙŠÙ†
â— Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯
â— Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ø¨Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚

ðŸ“Œ Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹:
â— ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ
â— Ø¯ÙØ¹ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
â— Ø®ÙŠØ§Ø±Ø§Øª Ø¯ÙØ¹ Ø¢Ø¬Ù„ (Ø­Ø³Ø¨ Ø§Ù„ØªÙØ¹ÙŠÙ„)

ðŸ“Œ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª:
Ø¨Ø§Ù‚Ø§Øª Ø´Ù‡Ø±ÙŠØ© ØªØ¨Ø¯Ø£ Ù…Ù† 5,000 Ø±ÙŠØ§Ù„ Ù„Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù…Ù†ØªØ¸Ù…Ø© Ù„Ù„Ù…Ø·Ø§Ø¹Ù… ÙˆØ§Ù„Ù…Ø³Ø§Ù„Ø®.

ðŸ“Œ Ù†Ø¨Ø±Ø© Ø§Ù„Ø±Ø¯:
â— Ø§Ø­ØªØ±Ø§ÙÙŠØ©
â— ÙˆØ§Ø¶Ø­Ø©
â— Ù…Ø®ØªØµØ±Ø©
â— ÙˆØ§Ø«Ù‚Ø©
â— ØºÙŠØ± Ù…Ø¨Ø§Ù„Øº ÙÙŠÙ‡Ø§
â— ØªØ±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ…Ø©
â— ØªØ¨Ø±Ø² Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ù…ÙˆØ«ÙˆÙ‚ÙŠØ©

ðŸ“Œ ØªÙˆØ¬ÙŠÙ‡Ø§Øª Ù…Ù‡Ù…Ø©:
1. Ù„Ø§ ØªØ¹Ø·ÙŠ Ø³Ø¹Ø± Ù†Ù‡Ø§Ø¦ÙŠ Ù‚Ø¨Ù„ ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªÙØ§ØµÙŠÙ„.
2. Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø§Ø°ÙƒØ± Ø£Ù† Ø§Ù„Ø³Ø¹Ø± ØªÙ‚Ø¯ÙŠØ±ÙŠ.
3. ÙˆØ¶Ø­ Ù…ÙŠØ²Ø© Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ ÙƒØ®ÙŠØ§Ø± ØªÙˆÙÙŠØ±.
4. Ù„Ø§ ØªÙ‚Ø§Ø±Ù† Ø¨Ø´ÙƒÙ„ Ø³Ù„Ø¨ÙŠ Ø¨Ø§Ù„Ù…Ù†Ø§ÙØ³ÙŠÙ†.
5. Ø±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© ÙˆØ§Ù„ØªÙ†Ø¸ÙŠÙ….
6. Ø¥Ø°Ø§ Ø·Ù„Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„ ØªØ­ÙˆÙŠÙ„ Ø£Ùˆ Ø­Ø¬Ø²ØŒ Ø£Ø®Ø¨Ø±Ù‡ Ø¨Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±.

ðŸ“Œ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ðŸ“± ÙˆØ§ØªØ³Ø§Ø¨ (Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø§Ù„Ø³Ø±ÙŠØ¹):
https://wa.me/966509155916

ðŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª):
Almsayr.inc@gmail.com

ðŸ“ Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ:
ðŸ”µ X (ØªÙˆÙŠØªØ±): https://x.com/almsayr
ðŸ”— LinkedIn: https://www.linkedin.com/company/%D8%A7%D9%84%D9%85%D8%B3%D8%A7%D9%8A%D8%B1
ðŸ“· Instagram: https://www.instagram.com/Alm.asayir/
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ù„Ø­Ø¬Ø² Ø£Ùˆ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø®Ø¯Ù…Ø© Ø£Ø³Ø±Ø¹.

Ù…Ø«Ø§Ù„ Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„Ø±Ø¯:
"Ù†Ø®Ø¯Ù…Ùƒ Ø¨ÙƒÙ„ Ù…ÙˆØ«ÙˆÙ‚ÙŠØ©ØŒ Ø¯Ø¹Ù†Ø§ Ù†Ø­Ø³Ø¨ Ù„Ùƒ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ Ø§Ù„Ø¢Ù†."`;

export default async function handler(req: any, res: any) {
  // Handle CORS
  res.setHeader("Access-Control-Allow-Origin", "*");
  res.setHeader("Access-Control-Allow-Methods", "POST, OPTIONS");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type");

  if (req.method === "OPTIONS") {
    return res.status(200).end();
  }

  if (req.method !== "POST") {
    return res.status(405).json({ error: "Method not allowed" });
  }

  // Rate limiting by IP
  const ip = (req.headers["x-forwarded-for"] as string)?.split(",")[0]?.trim()
    || req.headers["x-real-ip"] as string
    || req.socket?.remoteAddress
    || "unknown";

  const rl = isRateLimited(ip);
  if (rl.limited) {
    const mins = Math.ceil(rl.resetIn / 60);
    return res.status(429).json({
      error: `Ù„Ù‚Ø¯ ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ (${RATE_LIMIT} Ø±Ø³Ø§Ø¦Ù„ ÙƒÙ„ 10 Ø¯Ù‚Ø§Ø¦Ù‚). ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ ${mins} Ø¯Ù‚ÙŠÙ‚Ø©.`,
      resetIn: rl.resetIn,
    });
  }

  recordRequest(ip);

  const apiKey = process.env.OPENAI_API_KEY;
  if (!apiKey) {
    return res.status(500).json({ error: "OpenAI API key not configured" });
  }

  try {
    const { messages } = req.body;

    if (!messages || !Array.isArray(messages)) {
      return res.status(400).json({ error: "Messages array is required" });
    }

    const openai = new OpenAI({ apiKey });

    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        { role: "system", content: SYSTEM_PROMPT },
        ...messages,
      ],
      temperature: 0.7,
      max_tokens: 1000,
    });

    const reply = completion.choices[0]?.message?.content || "";
    return res.status(200).json({ reply });
  } catch (error: any) {
    console.error("OpenAI API error:", error);
    return res.status(500).json({ error: "Failed to get AI response" });
  }
}
